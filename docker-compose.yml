# Docker Compose for StrataHub Local Development
# Usage:
#   docker compose up -d          # Start all services
#   docker compose up -d mongodb  # Start only MongoDB
#   docker compose logs -f app    # Follow app logs
#   docker compose down           # Stop all services
#   docker compose down -v        # Stop and remove volumes

services:
  # ==========================================================================
  # MongoDB Database
  # ==========================================================================
  mongodb:
    image: mongo:7
    container_name: stratahub-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - mongodb_data:/data/db
    environment:
      # For development, no auth. In production, use MONGO_INITDB_ROOT_USERNAME/PASSWORD
      MONGO_INITDB_DATABASE: strata_hub
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ==========================================================================
  # MailHog - Email Testing (captures all outgoing emails)
  # Web UI: http://localhost:8025
  # SMTP: localhost:1025
  # ==========================================================================
  mailhog:
    image: mailhog/mailhog:latest
    container_name: stratahub-mailhog
    restart: unless-stopped
    ports:
      - "1025:1025"   # SMTP server
      - "8025:8025"   # Web UI
    logging:
      driver: "none"  # Reduce log noise

  # ==========================================================================
  # StrataHub Application
  # ==========================================================================
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: stratahub-app
    restart: unless-stopped
    ports:
      - "8080:8080"
    depends_on:
      mongodb:
        condition: service_healthy
      mailhog:
        condition: service_started
    environment:
      # Runtime
      STRATAHUB_ENV: dev
      STRATAHUB_LOG_LEVEL: debug

      # Database
      STRATAHUB_MONGO_URI: mongodb://mongodb:27017
      STRATAHUB_MONGO_DATABASE: strata_hub

      # Email (MailHog)
      STRATAHUB_MAIL_SMTP_HOST: mailhog
      STRATAHUB_MAIL_SMTP_PORT: 1025
      STRATAHUB_MAIL_FROM: noreply@localhost
      STRATAHUB_MAIL_FROM_NAME: StrataHub
      STRATAHUB_BASE_URL: http://localhost:8080

      # Sessions (dev keys - change in production!)
      STRATAHUB_SESSION_KEY: docker-dev-session-key-change-in-prod-1234
      STRATAHUB_CSRF_KEY: docker-dev-csrf-key-change-in-production-1234

      # Multi-workspace (disabled for local dev by default)
      STRATAHUB_MULTI_WORKSPACE: "false"
      STRATAHUB_DEFAULT_WORKSPACE_NAME: Default

      # File storage
      STRATAHUB_STORAGE_TYPE: local
      STRATAHUB_STORAGE_LOCAL_PATH: /app/uploads/materials
      STRATAHUB_STORAGE_LOCAL_URL: /files/materials
    volumes:
      # Persist uploaded files
      - uploads_data:/app/uploads
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 3s
      retries: 3
      start_period: 10s

volumes:
  mongodb_data:
    name: stratahub-mongodb-data
  uploads_data:
    name: stratahub-uploads

# ==========================================================================
# Development Tips:
# ==========================================================================
#
# 1. Run only dependencies (MongoDB + MailHog) for local Go development:
#    docker compose up -d mongodb mailhog
#    Then run: go run ./cmd/stratahub
#
# 2. View captured emails:
#    Open http://localhost:8025 in your browser
#
# 3. Connect to MongoDB:
#    mongosh mongodb://localhost:27017/strata_hub
#
# 4. View app logs:
#    docker compose logs -f app
#
# 5. Rebuild after code changes:
#    docker compose up -d --build app
#
# 6. Reset database:
#    docker compose down -v
#    docker compose up -d
#
# ==========================================================================
# Multi-Workspace Development:
# ==========================================================================
#
# To test multi-workspace mode locally:
#
# 1. Add to /etc/hosts:
#    127.0.0.1 stratahub.local
#    127.0.0.1 app.stratahub.local
#    127.0.0.1 team1.stratahub.local
#
# 2. Set environment variables:
#    STRATAHUB_MULTI_WORKSPACE: "true"
#    STRATAHUB_PRIMARY_DOMAIN: stratahub.local
#    STRATAHUB_SESSION_DOMAIN: .stratahub.local
#    STRATAHUB_BASE_URL: http://stratahub.local:8080
#
# 3. Access at http://stratahub.local:8080
