{{ define "settings" }}
  {{ template "layout" . }}
{{ end }}

{{ define "content" }}
<div class="mb-4">
  <h1 class="text-2xl font-bold text-gray-800 dark:text-gray-200 mb-1">âš™ï¸ Site Settings</h1>
</div>

{{ if .Error }}
  <div class="mb-3 p-2 border border-red-300 dark:border-red-700 bg-red-50 dark:bg-red-900/30 text-red-700 dark:text-red-300 rounded">
    {{ .Error }}
  </div>
{{ end }}

<form method="post" action="/settings" enctype="multipart/form-data" class="space-y-4 bg-white dark:bg-gray-800 p-4 rounded shadow">

  <div>
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Site Name</label>
    <input name="site_name" type="text" value="{{ .SiteName }}" required
           class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 p-2 rounded text-sm" />
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">This name appears in the menu header.</p>
  </div>

  <div class="border-t dark:border-gray-700 pt-4">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Logo</label>
    {{ if .HasLogo }}
      <div class="mb-3 p-3 bg-gray-50 dark:bg-gray-700 rounded border dark:border-gray-600">
        <div class="flex items-center gap-4">
          <img src="{{ .LogoURL }}" alt="Current logo" class="h-12 w-auto rounded">
          <div class="flex-1">
            <p class="text-sm text-gray-700 dark:text-gray-300">{{ .LogoName }}</p>
            <div class="flex gap-2 mt-1">
              <a href="{{ .LogoURL }}" target="_blank" class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">View</a>
              <a href="{{ .LogoURL }}" download="{{ .LogoName }}" class="px-2 py-1 bg-green-600 text-white text-xs rounded hover:bg-green-700">Download</a>
            </div>
          </div>
        </div>
        <div class="mt-3 pt-3 border-t dark:border-gray-600">
          <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Replace Logo</label>
          <input name="logo" type="file" accept="image/*"
                 class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 p-2 rounded text-sm">
          <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Upload a new image to replace the current logo.</p>
        </div>
        <div class="mt-3">
          <label class="flex items-center text-sm text-gray-700 dark:text-gray-300">
            <input type="checkbox" name="remove_logo" value="1" class="mr-2">
            Remove logo
          </label>
        </div>
      </div>
    {{ else }}
      <input name="logo" type="file" accept="image/*"
             class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 p-2 rounded text-sm">
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Upload an image file for your site logo.</p>
    {{ end }}
  </div>

  <div class="border-t dark:border-gray-700 pt-4">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Authentication Methods</label>
    <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">
      Select which authentication methods are available for users in this workspace.
      At least one method must remain enabled.
    </p>
    <div class="space-y-2 bg-gray-50 dark:bg-gray-700 p-3 rounded border dark:border-gray-600">
      {{ range .AllAuthMethods }}
      <label class="flex items-center">
        <input type="checkbox" name="auth_methods" value="{{ .Value }}"
               {{ if index $.EnabledAuthMethods .Value }}checked{{ end }}
               {{ if eq $.CurrentUserMethod .Value }}disabled{{ end }}
               class="mr-2 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 disabled:opacity-50">
        <span class="text-sm text-gray-700 dark:text-gray-300">{{ .Label }}</span>
        {{ if eq $.CurrentUserMethod .Value }}
        <span class="ml-2 text-xs text-yellow-600 dark:text-yellow-400">(your current method)</span>
        <!-- Hidden input to ensure the value is submitted when checkbox is disabled -->
        <input type="hidden" name="auth_methods" value="{{ .Value }}">
        {{ end }}
      </label>
      {{ end }}
    </div>
  </div>

  <div class="border-t dark:border-gray-700 pt-4">
    <div class="flex items-center justify-between mb-2">
      <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Landing Page</label>
      <a href="/" target="_blank" class="px-2 py-1 bg-indigo-600 text-white text-xs rounded hover:bg-indigo-700">View Landing Page</a>
    </div>
    <p class="text-xs text-gray-500 dark:text-gray-400 mb-3">
      The landing page is the first page visitors see when they arrive at your workspace.
    </p>

    <div class="mb-3">
      <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Title</label>
      <input name="landing_title" type="text" value="{{ .LandingTitle }}"
             class="w-full border dark:border-gray-600 dark:bg-gray-700 dark:text-gray-100 p-2 rounded text-sm"
             placeholder="ğŸ  Welcome" />
      <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Include an emoji at the start if desired (e.g., ğŸ  Welcome).</p>
    </div>

    <div>
      <label class="block text-sm text-gray-700 dark:text-gray-300 mb-1">Content</label>
      <input type="hidden" name="landing_content" id="landing_content" value="{{ .LandingContent }}">
      <div class="tiptap-container">
        <!-- Toolbar -->
        <div class="tiptap-toolbar" id="landing-editor-toolbar">
          <button type="button" data-action="bold" title="Bold (Ctrl+B)"><b>B</b></button>
          <button type="button" data-action="italic" title="Italic (Ctrl+I)"><i>I</i></button>
          <button type="button" data-action="underline" title="Underline (Ctrl+U)"><u>U</u></button>
          <button type="button" data-action="strike" title="Strikethrough"><s>S</s></button>
          <span class="tiptap-toolbar-divider"></span>
          <button type="button" data-action="heading1" title="Heading 1">H1</button>
          <button type="button" data-action="heading2" title="Heading 2">H2</button>
          <button type="button" data-action="heading3" title="Heading 3">H3</button>
          <button type="button" data-action="paragraph" title="Paragraph">P</button>
          <span class="tiptap-toolbar-divider"></span>
          <button type="button" data-action="bulletList" title="Bullet List">â€¢</button>
          <button type="button" data-action="orderedList" title="Numbered List">1.</button>
          <button type="button" data-action="blockquote" title="Quote">"</button>
          <button type="button" data-action="codeBlock" title="Code Block">&lt;/&gt;</button>
          <span class="tiptap-toolbar-divider"></span>
          <button type="button" data-action="link" title="Add Link">ğŸ”—+</button>
          <button type="button" data-action="unlink" title="Remove Link">ğŸ”—âœ•</button>
          <span class="tiptap-toolbar-break"></span>
          <button type="button" data-action="insertTable" title="Insert Table">â–¦</button>
          <button type="button" data-action="addColumnBefore" title="Add Column Before">â†|</button>
          <button type="button" data-action="addColumnAfter" title="Add Column After">|â†’</button>
          <button type="button" data-action="deleteColumn" title="Delete Column">|âœ•</button>
          <button type="button" data-action="addRowBefore" title="Add Row Above">â†‘â€“</button>
          <button type="button" data-action="addRowAfter" title="Add Row Below">â†“â€“</button>
          <button type="button" data-action="deleteRow" title="Delete Row">â€“âœ•</button>
          <button type="button" data-action="deleteTable" title="Delete Table">â–¦âœ•</button>
          <span class="tiptap-toolbar-divider"></span>
          <button type="button" data-action="undo" title="Undo (Ctrl+Z)">â†¶</button>
          <button type="button" data-action="redo" title="Redo (Ctrl+Y)">â†·</button>
        </div>
        <!-- Editor -->
        <div id="landing-editor"></div>
      </div>
    </div>
  </div>

  <div class="border-t dark:border-gray-700 pt-4">
    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Footer HTML</label>
    <input type="hidden" name="footer_html" id="footer_html" value="{{ .FooterHTML }}">
    <div class="tiptap-container">
      <!-- Toolbar -->
      <div class="tiptap-toolbar" id="editor-toolbar">
        <button type="button" data-action="bold" title="Bold (Ctrl+B)"><b>B</b></button>
        <button type="button" data-action="italic" title="Italic (Ctrl+I)"><i>I</i></button>
        <button type="button" data-action="underline" title="Underline (Ctrl+U)"><u>U</u></button>
        <button type="button" data-action="strike" title="Strikethrough"><s>S</s></button>
        <span class="tiptap-toolbar-divider"></span>
        <button type="button" data-action="heading1" title="Heading 1">H1</button>
        <button type="button" data-action="heading2" title="Heading 2">H2</button>
        <button type="button" data-action="heading3" title="Heading 3">H3</button>
        <button type="button" data-action="paragraph" title="Paragraph">P</button>
        <span class="tiptap-toolbar-divider"></span>
        <button type="button" data-action="bulletList" title="Bullet List">â€¢</button>
        <button type="button" data-action="orderedList" title="Numbered List">1.</button>
        <button type="button" data-action="blockquote" title="Quote">"</button>
        <button type="button" data-action="codeBlock" title="Code Block">&lt;/&gt;</button>
        <span class="tiptap-toolbar-divider"></span>
        <button type="button" data-action="link" title="Add Link">ğŸ”—+</button>
        <button type="button" data-action="unlink" title="Remove Link">ğŸ”—âœ•</button>
        <span class="tiptap-toolbar-break"></span>
        <button type="button" data-action="insertTable" title="Insert Table">â–¦</button>
        <button type="button" data-action="addColumnBefore" title="Add Column Before">â†|</button>
        <button type="button" data-action="addColumnAfter" title="Add Column After">|â†’</button>
        <button type="button" data-action="deleteColumn" title="Delete Column">|âœ•</button>
        <button type="button" data-action="addRowBefore" title="Add Row Above">â†‘â€“</button>
        <button type="button" data-action="addRowAfter" title="Add Row Below">â†“â€“</button>
        <button type="button" data-action="deleteRow" title="Delete Row">â€“âœ•</button>
        <button type="button" data-action="deleteTable" title="Delete Table">â–¦âœ•</button>
        <span class="tiptap-toolbar-divider"></span>
        <button type="button" data-action="undo" title="Undo (Ctrl+Z)">â†¶</button>
        <button type="button" data-action="redo" title="Redo (Ctrl+Y)">â†·</button>
      </div>
      <!-- Editor -->
      <div id="editor"></div>
    </div>
    <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">Custom HTML that appears in the footer of every page.</p>
  </div>

  <div class="flex gap-3 pt-4 border-t dark:border-gray-700">
    <button type="submit" class="px-4 py-2 bg-indigo-600 text-white rounded text-sm hover:bg-indigo-700">
      Save Settings
    </button>
    <a href="/dashboard" class="px-4 py-2 border dark:border-gray-600 rounded text-sm hover:bg-gray-50 dark:hover:bg-gray-700">
      Cancel
    </a>
  </div>
</form>

<script src="/assets/js/tiptap.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Helper to set up a TipTap editor with toolbar
  function setupEditor(editorId, hiddenInputId, toolbarId) {
    const initialContent = document.getElementById(hiddenInputId).value || '';
    const editor = window.TiptapEditor.create(editorId, hiddenInputId, initialContent);

    if (!editor) return null;

    const toolbar = document.getElementById(toolbarId);
    toolbar.addEventListener('click', function(e) {
      const btn = e.target.closest('button');
      if (!btn) return;

      const action = btn.dataset.action;
      switch(action) {
        case 'bold': editor.chain().focus().toggleBold().run(); break;
        case 'italic': editor.chain().focus().toggleItalic().run(); break;
        case 'underline': editor.chain().focus().toggleUnderline().run(); break;
        case 'strike': editor.chain().focus().toggleStrike().run(); break;
        case 'heading1': editor.chain().focus().toggleHeading({ level: 1 }).run(); break;
        case 'heading2': editor.chain().focus().toggleHeading({ level: 2 }).run(); break;
        case 'heading3': editor.chain().focus().toggleHeading({ level: 3 }).run(); break;
        case 'paragraph': editor.chain().focus().setParagraph().run(); break;
        case 'bulletList': editor.chain().focus().toggleBulletList().run(); break;
        case 'orderedList': editor.chain().focus().toggleOrderedList().run(); break;
        case 'blockquote': editor.chain().focus().toggleBlockquote().run(); break;
        case 'codeBlock': editor.chain().focus().toggleCodeBlock().run(); break;
        case 'link':
          const url = prompt('Enter URL:');
          if (url) editor.chain().focus().setLink({ href: url }).run();
          break;
        case 'unlink': editor.chain().focus().unsetLink().run(); break;
        case 'insertTable': editor.chain().focus().insertTable({ rows: 3, cols: 3, withHeaderRow: true }).run(); break;
        case 'addColumnBefore': editor.chain().focus().addColumnBefore().run(); break;
        case 'addColumnAfter': editor.chain().focus().addColumnAfter().run(); break;
        case 'deleteColumn': editor.chain().focus().deleteColumn().run(); break;
        case 'addRowBefore': editor.chain().focus().addRowBefore().run(); break;
        case 'addRowAfter': editor.chain().focus().addRowAfter().run(); break;
        case 'deleteRow': editor.chain().focus().deleteRow().run(); break;
        case 'deleteTable': editor.chain().focus().deleteTable().run(); break;
        case 'undo': editor.chain().focus().undo().run(); break;
        case 'redo': editor.chain().focus().redo().run(); break;
      }
      updateToolbarState(editor, toolbar);
    });

    function updateToolbarState(ed, tb) {
      tb.querySelectorAll('button[data-action]').forEach(btn => {
        const action = btn.dataset.action;
        let isActive = false;
        switch(action) {
          case 'bold': isActive = ed.isActive('bold'); break;
          case 'italic': isActive = ed.isActive('italic'); break;
          case 'underline': isActive = ed.isActive('underline'); break;
          case 'strike': isActive = ed.isActive('strike'); break;
          case 'heading1': isActive = ed.isActive('heading', { level: 1 }); break;
          case 'heading2': isActive = ed.isActive('heading', { level: 2 }); break;
          case 'heading3': isActive = ed.isActive('heading', { level: 3 }); break;
          case 'paragraph': isActive = ed.isActive('paragraph'); break;
          case 'bulletList': isActive = ed.isActive('bulletList'); break;
          case 'orderedList': isActive = ed.isActive('orderedList'); break;
          case 'blockquote': isActive = ed.isActive('blockquote'); break;
          case 'codeBlock': isActive = ed.isActive('codeBlock'); break;
          case 'link': isActive = ed.isActive('link'); break;
        }
        btn.classList.toggle('is-active', isActive);
      });
    }

    editor.on('selectionUpdate', () => updateToolbarState(editor, toolbar));
    editor.on('update', () => updateToolbarState(editor, toolbar));

    return editor;
  }

  // Initialize both editors
  setupEditor('landing-editor', 'landing_content', 'landing-editor-toolbar');
  setupEditor('editor', 'footer_html', 'editor-toolbar');
});
</script>
{{ end }}
